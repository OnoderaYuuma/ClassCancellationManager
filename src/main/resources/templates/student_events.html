<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::title}, ~{::#content}, ~{::#custom-css}, ~{::#custom-js})}">
<head>
    <title>授業予定カレンダー</title>

    <th:block id="custom-css">
        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
        <style>
            /* 履修登録を促すメッセージのスタイル */
            .enrollment-prompt {
                border: 1px solid #0d6efd;
                background-color: #e7f1ff;
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-radius: .25rem;
            }
            .enrollment-prompt a {
                font-weight: bold;
            }
            #calendar a {
                color: inherit;
                text-decoration: none;
            }
        </style>
    </th:block>
</head>
<body>

<div id="content">

    <div th:if="${showEnrollmentPrompt}" class="enrollment-prompt">
        <p class="mb-1">新しい学期の履修登録がまだ完了していない可能性があります。</p>
        <a th:href="@{/student/enrollment}">履修登録画面へ進む &raquo;</a>
    </div>

    <div id="calendar"></div>

</div>

<th:block id="custom-js">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // Controllerから渡されたModelの 'events' をJavaScriptの変数に変換する
        const eventsJson = /*[[${eventsJson}]]*/ '[]';
        const events = JSON.parse(eventsJson);

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');

            const calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                initialView: 'dayGridMonth',
                locale: 'ja',
                navLinks: true,
                editable: false,
                dayMaxEvents: true,
                events: events,
                height: '84vh',
                eventClick: function(info) {
                    let eventDetails = `授業名: ${info.event.title}\n日時: ${info.event.start.toLocaleString()}\n詳細: ${info.event.extendedProps.description || '特になし'}`;
                    const originalEvent = info.event.extendedProps;
                    if (originalEvent.eventType === 'CANCELLATION' && originalEvent.makeupDate) {
                        eventDetails += `\n振替日: ${originalEvent.makeupDate}\n振替時限: ${originalEvent.makeupPeriod}限`;
                    }
                    alert(eventDetails);
                }
            });

            calendar.render();
        });

        /*]]>*/
    </script>
</th:block>

</body>
</html>